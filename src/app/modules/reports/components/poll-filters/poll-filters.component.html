<form [formGroup]="filterForm">
  @if (!evaluations) {
    <p class="error-message">
      There was an error looking for evaluation processes. Please contact
      support.
    </p>
  }
  <div class="form-container">
    @if (evaluations && evaluations.length > 0) {
      <mat-form-field appearance="fill">
        <mat-label for="sl-evaluation">Evaluation</mat-label>
        <mat-select
          id="sl-evaluation"
          formControlName="selectedEvaluation"
          (selectionChange)="handleEvaluationSelect($event)"
        >
          @for (evaluation of evaluations; track $index) {
            <mat-option class="versioned-option" [value]="evaluation">
              <p>{{ `${evaluation.name} - ${evaluation.status}`}}</p>
            </mat-option>
          }
        </mat-select>
        @if (filterForm.get('selectedEvaluation')?.errors) {
          <mat-error>This field is required</mat-error>
        }
      </mat-form-field>
    }
    @if (polls.length > 0) {
      <mat-form-field appearance="fill">
        <mat-label for="sl-poll">Poll</mat-label>
        <mat-select
          id="sl-poll"
          formControlName="selectedPoll"
          (selectionChange)="handlePollSelect($event)"
        >
          @for (poll of polls; track $index) {
            <mat-option class="versioned-option" [value]="poll">
              <p>{{ poll.name }}</p>
            </mat-option>
          }
        </mat-select>
        @if (filterForm.get('selectedPoll')?.errors) {
          <mat-error>This field is required</mat-error>
        }
      </mat-form-field>
    }
    @if (filterForm.value.selectedPoll) {
      <mat-form-field appearance="fill">
        <mat-label for="sl-cohort">Cohort</mat-label>
        <mat-select
          id="sl-cohort"
          multiple
          formControlName="cohortIds"
          (openedChange)="handleCohortSelect($event)"
        >
          <mat-select-trigger>
            <app-selected-items
              [items]="getCohortsSelection()"
            ></app-selected-items>
          </mat-select-trigger>
          @if (cohorts.length > 0) {
            <mat-option appSelectAll [allValues]="cohorts"
              >Select all</mat-option
            >
          }
          @for (cohort of cohorts; track $index) {
            <mat-option [value]="cohort.id">
              {{ cohort.name }}
            </mat-option>
          }
        </mat-select>
      </mat-form-field>
    }
    @if (
      filterForm.value.cohortIds &&
      filterForm.value.cohortIds.length &&
      showVariables
    ) {
      <mat-form-field appearance="fill">
        <mat-label for="sl-component">Components</mat-label>
        <mat-select
          required
          id="sl-components"
          multiple
          (openedChange)="handleComponentsSelect($event)"
          formControlName="componentNames"
        >
          <mat-select-trigger>
            <app-selected-items
              [items]="getComponentsSelection()"
            ></app-selected-items>
          </mat-select-trigger>
          @if (!!componentNames.length) {
            <mat-option appSelectAll [allValues]="componentNames"
              >Select all</mat-option
            >
          }
          @for (component of componentNames; track $index) {
            <mat-option [value]="component">
              {{ component }}
            </mat-option>
          }
        </mat-select>
        @if (filterForm.get('componentNames')?.errors) {
          <mat-error>This field is required</mat-error>
        }
      </mat-form-field>
    }
    @if (
      filterForm.value.cohortIds &&
      filterForm.value.cohortIds.length &&
      showVariables
    ) {
      <mat-form-field appearance="fill">
        <mat-label for="variables">Variables</mat-label>
        <mat-select
          id="sl-variables"
          multiple
          (openedChange)="handleVariableSelect($event)"
          formControlName="variables"
        >
          <mat-select-trigger>
            <app-selected-items
              [items]="getVariablesSelection()"
            ></app-selected-items>
          </mat-select-trigger>
          @if (!!variables.length) {
            <mat-option appSelectAll [allValues]="getAllVariableIds()"
              >Select all</mat-option
            >
          }
          @for (group of variableGroups; track group) {
            @if (!!group.length) {
              <mat-optgroup [label]="group[0].componentName | uppercase">
                @for (variable of group; track variable.pollVariableId) {
                  <mat-option
                    class="group-option"
                    [value]="variable.pollVariableId"
                    >{{ variable.name }}</mat-option
                  >
                }
              </mat-optgroup>
            }
          }
        </mat-select>
      </mat-form-field>
    }
  </div>
</form>
